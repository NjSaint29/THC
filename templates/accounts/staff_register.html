{% extends 'base.html' %}

{% block title %}Register Staff Member - Tiko Health Campaign{% endblock %}

{% block nav_items %}
<li class="nav-item">
    <a class="nav-link" href="{% url 'accounts:staff_list' %}">
        <i class="fas fa-users"></i> Staff List
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{% url 'accounts:staff_register' %}">
        <i class="fas fa-user-plus"></i> Register Staff
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'accounts:role_permissions' %}">
        <i class="fas fa-shield-alt"></i> Role Permissions
    </a>
</li>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-user-plus"></i> Register New Staff Member</h1>
                <a href="{% url 'accounts:staff_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Staff List
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user-plus"></i> Staff Registration Form</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="staffForm">
                        {% csrf_token %}
                        
                        <!-- Personal Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-user"></i> Personal Information</h6>
                                <hr>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                    First Name <span class="text-danger">*</span>
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger small">{{ form.first_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                    Last Name <span class="text-danger">*</span>
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Account Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-key"></i> Account Information</h6>
                                <hr>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.username.id_for_label }}" class="form-label">
                                    Username <span class="text-danger">*</span>
                                </label>
                                {{ form.username }}
                                {% if form.username.errors %}
                                    <div class="text-danger small">{{ form.username.errors.0 }}</div>
                                {% endif %}
                                <small class="text-muted">Used for logging into the system</small>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    Email Address <span class="text-danger">*</span>
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger small">{{ form.email.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Password -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.password1.id_for_label }}" class="form-label">
                                    Password <span class="text-danger">*</span>
                                </label>
                                {{ form.password1 }}
                                {% if form.password1.errors %}
                                    <div class="text-danger small">{{ form.password1.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.password2.id_for_label }}" class="form-label">
                                    Confirm Password <span class="text-danger">*</span>
                                </label>
                                {{ form.password2 }}
                                {% if form.password2.errors %}
                                    <div class="text-danger small">{{ form.password2.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Role and Contact -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-user-tag"></i> Role & Contact</h6>
                                <hr>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.role.id_for_label }}" class="form-label">
                                    Role <span class="text-danger">*</span>
                                </label>
                                {{ form.role }}
                                {% if form.role.errors %}
                                    <div class="text-danger small">{{ form.role.errors.0 }}</div>
                                {% endif %}
                                <small class="text-muted">{{ form.role.help_text }}</small>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                    Phone Number
                                </label>
                                {{ form.phone_number }}
                                {% if form.phone_number.errors %}
                                    <div class="text-danger small">{{ form.phone_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-toggle-on"></i> Account Status</h6>
                                <hr>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        <strong>Active Account</strong>
                                    </label>
                                    {% if form.is_active.errors %}
                                        <div class="text-danger small">{{ form.is_active.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">{{ form.is_active.help_text }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Errors -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'accounts:staff_list' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-user-plus"></i> Register Staff Member
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Role Information -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Role Information</h5>
                </div>
                <div class="card-body">
                    <div id="roleInfo">
                        <p class="text-muted">Select a role to see permissions and responsibilities.</p>
                    </div>
                </div>
            </div>

            <!-- Registration Guidelines -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-list"></i> Registration Guidelines</h5>
                </div>
                <div class="card-body">
                    <h6>Required Information:</h6>
                    <ul class="small">
                        <li>Full name (first and last)</li>
                        <li>Unique username</li>
                        <li>Valid email address</li>
                        <li>Secure password</li>
                        <li>Appropriate role selection</li>
                    </ul>
                    
                    <h6>Password Requirements:</h6>
                    <ul class="small">
                        <li>At least 8 characters long</li>
                        <li>Cannot be too common</li>
                        <li>Cannot be entirely numeric</li>
                        <li>Cannot be too similar to personal info</li>
                    </ul>
                    
                    <h6>Role Assignment:</h6>
                    <p class="small">
                        Each role has specific permissions and access levels. 
                        Choose the role that matches the staff member's 
                        responsibilities in the health campaign.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Role information mapping
const roleInfo = {
    'registration_clerk': {
        title: 'Registration Clerk',
        description: 'Handles section A: DEMOGRAPHIC AND BIOGRAPHIC DATA',
        permissions: [
            'View list of active campaigns',
            'Register new patients',
            'Auto-generate Patient ID',
            'View patient demographics'
        ],
        restrictions: [
            'Cannot view clinical parameters',
            'Cannot view consultation/diagnosis',
            'Cannot view lab results',
            'Cannot view prescriptions'
        ]
    },
    'vitals_clerk': {
        title: 'Vitals Clerk',
        description: 'Handles section B: CLINICAL PARAMETERS',
        permissions: [
            'Search by Patient ID or name',
            'View demographics (read-only)',
            'Enter/update clinical parameters'
        ],
        restrictions: [
            'Cannot edit demographics',
            'Cannot view consultation/diagnosis',
            'Cannot view lab results',
            'Cannot view prescriptions'
        ]
    },
    'doctor': {
        title: 'Doctor',
        description: 'Handles sections C and E: MEDICAL CONSULTATION and PRESCRIPTIONS',
        permissions: [
            'View full patient record',
            'Enter/update consultation details',
            'Enter/update diagnosis',
            'Order lab tests',
            'Write prescriptions'
        ],
        restrictions: [
            'Cannot edit demographics',
            'Cannot edit vitals',
            'Cannot edit lab results'
        ]
    },
    'lab_technician': {
        title: 'Lab Technician',
        description: 'Handles section D: LABORATORY TEST RESULTS',
        permissions: [
            'Search by Patient ID or name',
            'View demographics, vitals, and requested tests',
            'Enter/update lab test results',
            'Add test conclusions'
        ],
        restrictions: [
            'Cannot edit demographics',
            'Cannot edit vitals',
            'Cannot edit consultation/diagnosis',
            'Cannot edit prescriptions'
        ]
    }
};

// Update role information when role is selected
document.getElementById('id_role').addEventListener('change', function() {
    const selectedRole = this.value;
    const infoDiv = document.getElementById('roleInfo');
    
    if (selectedRole && roleInfo[selectedRole]) {
        const info = roleInfo[selectedRole];
        infoDiv.innerHTML = `
            <h6 class="text-primary">${info.title}</h6>
            <p class="small">${info.description}</p>
            
            <h6 class="text-success">Permissions:</h6>
            <ul class="small">
                ${info.permissions.map(p => `<li>${p}</li>`).join('')}
            </ul>
            
            <h6 class="text-danger">Restrictions:</h6>
            <ul class="small">
                ${info.restrictions.map(r => `<li>${r}</li>`).join('')}
            </ul>
        `;
    } else {
        infoDiv.innerHTML = '<p class="text-muted">Select a role to see permissions and responsibilities.</p>';
    }
});

// Form validation
document.getElementById('staffForm').addEventListener('submit', function(e) {
    const password1 = document.getElementById('id_password1').value;
    const password2 = document.getElementById('id_password2').value;
    
    if (password1 !== password2) {
        e.preventDefault();
        alert('Passwords do not match!');
        return false;
    }
});
</script>
{% endblock %}
